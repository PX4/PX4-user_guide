# Налаштування оцінки батареї (Налаштування енергії)

Ця тема пояснює, як налаштувати параметри живлення так, щоб PX4 міг оцінити наявну ємність акумулятора.

:::info Ці інструкції передбачають, що у транспортному засобі є [Модуль живлення (PM)](../power_module/index.md), або інше обладнання, яке може вимірювати напругу батареї та (за бажанням) струм.

Цю настройку не потрібно для [Аккумулятори Smart/MAVLink](../smart_batteries/index.md).
:::

## Загальний огляд

Налаштування оцінки батареї використовує виміряну напругу та силу струму (якщо доступно) для оцінки залишкової ємності батареї. Це важливо, оскільки це дозволяє PX4 діяти, коли транспортний засіб майже розряджений і збирається врізатися (а також запобігає пошкодженню акумулятора внаслідок глибокого розряду).

PX4 надає ряд (поступово більш ефективних) методів, які можна використовувати для оцінки місткості:

1. [Основні налаштування батареї](#basic_settings) (за замовчуванням): сировинне вимірюване напруга порівнюється з діапазоном між напругами "порожньої" та "повної". Це призводить до грубих оцінок, оскільки виміряна напруга (і відповідна ємність) буде коливатися під навантаженням.
1. [Оцінка на основі напруги з компенсацією навантаження](#load_compensation): Компенсує вплив навантаження на розрахунок ємності.
1. [Оцінка на основі напруги з інтеграцією поточного заряду](#current_integration): Поєднує навантажену оцінку доступної ємності на основі напруги з оцінкою поточного заряду, який був використаний. Це призводить до оцінки потужності, яка є порівнянною з потужністю розумної батареї.

Пізніші методи ґрунтуються на попередніх методах. Підхід, який ви використовуєте, буде залежати від того, чи може блок живлення автомобіля вимірювати струм.

::: info Інструкції нижче стосуються параметрів калібрування батареї 1: `BAT1_*`. Інші батареї використовують параметри `BATx_*`, де `x` - це номер батареї. Усі параметри калібрування батареї [перелічені тут](../advanced_config/parameter_reference.md#battery-calibration).
:::

:::tip
Крім налаштування PX4, про яке говориться тут, вам слід також переконатися, що обмеження напруги нижнього рівня ESC вимкнено або встановлено нижче очікуваної мінімальної напруги.
Це забезпечує, що поведінка аварійного відключення батареї керується PX4, і регулятори швидкості не відключатимуться, поки батарея все ще має заряд (згідно з налаштуванням "порожньої батареї", яке ви обрали).
:::

:::tip
[Порівняння типів батарей](#battery-chemistry-comparison) нижче пояснює різницю між основними типами батарей та як це впливає на налаштування батареї.
:::

<a id="basic_settings"></a>

## Основні налаштування батареї (за замовчуванням)

Основні налаштування батареї налаштовують PX4 на використання типового методу для оцінки ємності. Цей метод порівнює виміряну сирову напругу акумулятора з діапазоном між напругами акумуляторів для "порожніх" та "повних" акумуляторів (масштабований за кількістю акумуляторів).

:::info
Цей підхід призводить до досить грубих оцінок через коливання у оцінці заряду при зміні виміряної напруги під навантаженням.
:::

Для налаштування основних параметрів для акумулятора 1:

1. Запустіть _QGroundControl_ та підключіть транспортний засіб.
1. Виберіть **іконку "Q" > Налаштування транспортного засобу >  Електропостачання** (бічна панель), щоб відкрити _Налаштування електропостачання_.

Вам пропонується базові налаштування, які характеризують акумулятор. Розділи нижче пояснюють, які значення встановити для кожного поля.

![Налаштування живлення QGC](../../assets/qgc/setup/power/qgc_setup_power_px4.png)

:::info На момент написання _QGroundControl_ дозволяє встановлювати значення лише для батареї 1 у цьому перегляді. Для транспортних засобів з декількома батареями вам потрібно буде безпосередньо [встановити параметри](../advanced_config/parameters.md) для батареї 2 (`BAT2_*`), як описано в наступних розділах.
:::

### Кількість елементів (в серії)

Це встановлює кількість акумуляторів, які з'єднані послідовно в батареї. Зазвичай це буде записано на батареї у вигляді числа, за яким слідує "S" (наприклад, "3S", "5S").

:::info Напруга на одній гальванічній батареї залежить від хімічних властивостей типу батареї. Батареї літій-полімерні (LiPo) та літій-іонні мають однакове _номінальне_ напругу на одну комірку - 3,7В. Для досягнення вищих напруг (які більш ефективно живлять автомобіль), кілька елементів з'єднуються в _серію_. Напруга батареї на зажимах потім є кратною напрузі акумуляторної клітини.
:::

Якщо кількість акумуляторних елементів не вказана, ви можете розрахувати її, поділивши напругу батареї на номінальну напругу для одного елемента. Таблиця нижче показує відношення напруги до акумуляторів:

| Cells | LiPo (V) | LiIon (V) |
| ----- | -------- | --------- |
| 1S    | 3.7      | 3.7       |
| 2S    | 7.4      | 7.4       |
| 3S    | 11.1     | 11.1      |
| 4S    | 14.8     | 14.8      |
| 5S    | 18.5     | 18.5      |
| 6S    | 22.2     | 22.2      |

:::info Цей параметр відповідає [параметрам](../advanced_config/parameters.md): [BAT1_N_CELLS](../advanced_config/parameter_reference.md#BAT1_N_CELLS) та [BAT2_N_CELLS](../advanced_config/parameter_reference.md#BAT2_N_CELLS).
:::

### Повний напруга (на одну клітину)

Це встановлює _номінальну_ максимальну напругу кожної ділянки (найнижчу напругу, при якій ділянка буде вважатися "повною").

Значення повинно бути трохи нижче номінальної максимальної напруги акумулятора, але не так низько, щоб оцінювана ємність все ще була 100% після кількох хвилин польоту.

Відповідні значення для використання:

- **LiPo:** 4.05V (за замовчуванням у _QGroundControl_)
- **LiIon:** 4.05V

:::info
Напруга повністю зарядженого акумулятора може трохи знизитися з часом після заряджання.
Встановлення значення трохи нижче максимального компенсує це зниження.
:::

:::info Цей параметр відповідає [параметрам](../advanced_config/parameters.md): [BAT1_V_CHARGED](../advanced_config/parameter_reference.md#BAT1_V_CHARGED) та [BAT2_V_CHARGED](../advanced_config/parameter_reference.md#BAT2_V_CHARGED).
:::

### Порожній напруга (на одну клітину)

Це встановлює номінальну мінімально безпечну напругу кожної клітини (використання напруги нижче цієї може пошкодити батарею).

:::info
Не існує одного значення, при якому батарея вважається порожньою.
Якщо ви виберете занадто низьке значення, акумулятор може бути пошкоджений через глибоке розряджання (і/або транспортний засіб може зазнати аварії).
Якщо ви виберете значення, яке є занадто високим, ви можете непотрібно обмежити свій політ.
:::

Правило великого пальця для мінімальних напруг на одну клітину:

| Рівень                                                         | LiPo (V) | LiIon (V) |
| -------------------------------------------------------------- | -------- | --------- |
| Консервативний (напруга без навантаження)                      | 3.7      | 3         |
| "Реальний" мінімум (напруга під навантаженням/під час польоту) | 3.5      | 2.7       |
| Пошкодження акумулятора (напруга під навантаженням)            | 3.0      | 2.5       |

:::tip
під консервативним діапазоном, чим швидше ви зарядите акумулятор краще. Він триватиме довше і зменшить потужність.
:::

:::info Цей параметр відповідає [параметрам](../advanced_config/parameters.md): [BAT1_V_EMPTY](../advanced_config/parameter_reference.md#BAT1_V_EMPTY) та [BAT2_V_EMPTY](../advanced_config/parameter_reference.md#BAT2_V_EMPTY).
:::

### Роздільник напруги

Якщо у вас є транспортний засіб, який вимірює напругу через модуль живлення та ADC плати керування польотом, то ви повинні перевірити та калібрувати вимірювання один раз на дошці. Для калібрування вам знадобиться мультиметр.

Найлегший спосіб калібрування дільника полягає в тому, щоб використовувати _QGroundControl_ та слідувати по кроковому посібнику на [Налаштування > Налаштування живлення](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/setup_view/power.html) (Посібник користувача QGroundControl).

:::info Цей параметр відповідає параметрам: [BAT1_V_DIV](../advanced_config/parameter_reference.md#BAT1_V_DIV) та [BAT2_V_DIV](../advanced_config/parameter_reference.md#BAT2_V_DIV).
:::

<a id="current_divider"></a>

### Ампери на вольт

:::tip
Це налаштування не потрібне, якщо ви використовуєте базову конфігурацію (без компенсації навантаження тощо).
:::

Якщо ви використовуєте [Компенсацію навантаження на основі струму](#current_based_load_compensation) або [Інтеграцію струму](#current_integration), роздільник амперів на вольт повинен бути калібрований.

Найлегший спосіб калібрування дільників полягає в тому, щоб використовувати _QGroundControl_ та слідувати по кроковому посібнику на [Налаштування > Налаштування живлення](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/setup_view/power.html) (Посібник користувача QGroundControl).

:::info Ця настройка відповідає параметру(ам): [BAT1_A_PER_V](../advanced_config/parameter_reference.md#BAT1_A_PER_V) та [BAT2_A_PER_V](../advanced_config/parameter_reference.md#BAT2_A_PER_V).
:::

<a id="load_compensation"></a>

## Оцінка на основі напруги з компенсацією навантаження

:::info
При належній налаштуванні компенсації навантаження напруга, що використовується для оцінки ємності батареї, є набагато стабільнішою, варіюючись набагато менше при польоті вгору і вниз.
:::

Спроби компенсації навантаження спрямовані на протидію флуктуаціям у виміряному напрузі/оціненій ємності при навантаженні, які виникають при використанні [основної конфігурації](#basic_settings). Це працює шляхом оцінки, яка була б напруга для _навантаженого_ акумулятора, і використання цієї напруги (замість виміряної напруги) для оцінки залишкової ємності.

:::info Для використання компенсації навантаження все ще потрібно встановити [основну конфігурацію](#basic_settings). _Порожнє напруга_ ([BAT_V_EMPTY](../advanced_config/parameter_reference.md#BAT_V_EMPTY)) повинно бути встановлено вище (ніж без компенсації), оскільки компенсована напруга використовується для оцінки (зазвичай встановлюється трохи нижче очікуваної напруги відпочинку клітини після використання).
:::

PX4 підтримує два методи компенсації навантаження, які активуються шляхом [встановлення](../advanced_config/parameters.md) будь-одного з двох параметрів нижче:

- [BAT1_R_INTERNAL](../advanced_config/parameter_reference.md#BAT1_R_INTERNAL) - [Компенсація навантаження на основі струму](#current_based_load_compensation) (рекомендовано).
- [BAT1_V_LOAD_DROP](../advanced_config/parameter_reference.md#BAT1_V_LOAD_DROP) - [Компенсація навантаження на основі тяги](#thrust_based_load_compensation).

<a id="current_based_load_compensation"></a>

### Компенсація навантаження на основі струму (рекомендовано)

Цей метод компенсації навантаження ґрунтується на вимірюванні поточного навантаження для визначення навантаження. Воно набагато точніше, ніж [Компенсація навантаження на основі тяги](#thrust_based_load_compensation), але потребує мати датчик струму.

Щоб увімкнути цю функцію:

1. Встановіть параметр [BAT1_R_INTERNAL](../advanced_config/parameter_reference.md#BAT1_R_INTERNAL) на внутрішнє опір батареї 1 (і повторіть для інших батарей).

   :::tip
Є LiPo зарядники, які можуть вимірювати внутрішній опір вашої батареї.
Типове значення становить 5 мΩ на комірку, але воно може відрізнятися залежно від рейтингу розрядного струму, віку та стану комірок.
:::

1. Ви також повинні калібрувати [Делільник амперів на вольт](#current_divider) на екрані основних налаштувань.

<a id="thrust_based_load_compensation"></a>

### Компенсація навантаження на основі тяги

Цей метод компенсації навантаження оцінює навантаження на основі загального тягового зусилля, яке командується двигунам.

:::warning
Цей метод не є особливо точним через затримку між командою на тягу та поточним, а також тому, що тяга не лінійно пропорційна поточному. Використовуйте [Компенсацію навантаження на основі поточного сигналу](#current_based_load_compensation), якщо у вашому транспортному засобі є датчик струму.
:::

Щоб увімкнути цю функцію:

1. Встановіть параметр [BAT1_V_LOAD_DROP](../advanced_config/parameter_reference.md#BAT1_V_LOAD_DROP) на те, наскільки падає напруга на одній з батарей при повному відкритті дроселя.

<a id="current_integration"></a>

## Оцінка на основі напруги, поєднана з інтегруванням струму

:::info
Це найточніший спосіб вимірювання відносного споживання батареї.
Якщо все налаштовано правильно з здоровою та свіжою зарядженою батареєю при кожному запуску, тоді якість оцінки буде порівнянною з тим, що від розумної батареї (і теоретично дозволить точну оцінку залишкового часу польоту).
:::

Цей метод оцінює залишкову ємність акумулятора, поєднуючи оцінку _доступної_ ємності на основі напруги з оцінкою поточного заряду, який був використаний. Для цього потрібне обладнання, яке може точно вимірювати поточний стан.

Щоб увімкнути цю функцію:

1. Спочатку налаштуйте точну оцінку напруги за допомогою [компенсації навантаження на основі струму](#current_based_load_compensation).

:::tip
Включаючи калібрування налаштування [Подільник амперів на вольт](#current_divider).
:::

1. Встановіть параметр [BAT1_CAPACITY](../advanced_config/parameter_reference.md#BAT1_CAPACITY) на приблизно 90% від рекламної ємності батареї (зазвичай надруковано на етикетці батареї).

   :::info
Не встановлюйте це значення занадто високим, оскільки це може призвести до поганої оцінки або раптового зниження оціненої потужності.
:::

---

**Додаткова інформація**

Оцінка заряду, який був використаний протягом часу, формується математичним інтегруванням виміряного струму (цей підхід забезпечує дуже точні оцінки споживання енергії).

При запуску системи PX4 спочатку використовує оцінку на основі напруги для визначення початкового заряду батареї. Далі цю оцінку поєднується зі значенням з поточної інтеграції, щоб надати поєднану кращу оцінку. Відносна вартість, яку відводиться кожній оцінці в отриманому об'єднаному результаті, залежить від стану акумулятора. Чим порожніша батарея, тим більше напругової оцінки зливається. Це запобігає глибокому розряду (наприклад, через те, що воно було налаштовано з неправильною ємністю або початкове значення було неправильним).

Якщо ви завжди починаєте з здоровою повною батареєю, цей підхід схожий на той, який використовується смарт-батареєю.

:::info Поточна інтеграція не може бути використана самостійно (без оцінки на основі напруги), оскільки вона не має способу визначити початкову ємність _initial_. Оцінка напруги дозволяє оцінити початкову ємність і надає постійний зворотний зв'язок щодо можливих помилок (наприклад, якщо акумулятор несправний або якщо є неспівпадіння між ємністю, розрахованою за допомогою різних методів).
:::

## Порівняння хімії батареї

Цей розділ надає порівняльний огляд кількох різних типів акумуляторів (зокрема LiPo та Li-Ion).

### Загальний огляд

- Акумулятори Li-Ion мають вищу щільність енергії, ніж пакети акумуляторів Lipo, але це відбувається за рахунок нижчих швидкостей розряду та збільшення вартості акумулятора.
- Акумулятори LiPo легко доступні і можуть витримати вищі розрядні струми, які є типовими для мультироторних літальних апаратів.
- Вибір потрібно здійснювати на основі транспортного засобу та місії, яку виконують. Якщо абсолютна витривалість є метою, то є більше користі від переходу на літій-іонний акумулятор, але, так само, потрібно бути обережним. Отже, рішення повинно бути прийняте на підставі факторів, що оточують польот.

### Переваги

LiPo

- Дуже поширене
- Широкий асортимент розмірів, ємностей та напруг
- Недорогий
- Високі розрядні ставки відносно ємності (високі рейтинги C)
- Вищі показники заряду

Li-Ion

- Набагато вища енергетична щільність (до 60% вище)

### Недоліки:

LiPo

- Низька (відносна) щільність енергії
- Якість може відрізнятися від великої кількості постачальників

Li-Ion

- Не так часто
- Набагато дорожче
- Не доступно для великих розмірів та конфігурацій
- Усі клітини відносно малі, тому більші пакети складаються з багатьох клітин, зв'язаних послідовно і паралельно, щоб створити необхідне напругу та ємність
- Нижчі рівні розряду відносно розміру батареї (рейтинг C)
- Складніше адаптуватися до транспортних засобів, які потребують великих струмів
- Нижчі тарифи зарядки (відносно потужності)
- Вимагає більш суворого моніторингу температури під час заряджання та розряджання
- Вимагає змін налаштувань на ESC для використання максимальної ємності ("стандартні" налаштування низької напруги ESC занадто високі).
- При майже порожньому акумуляторі напруга така, що можлива різниця близько 3 В між Lipo та Li-ion (при використанні акумулятора 6S). Це може мати наслідки для очікувань з тяги.

### C Рейтинги

- Рейтинг C - це просто кратне заявленої ємності будь-якого типу батареї.
- Оцінка C є важливою (і відрізняється) як для швидкості заряду, так і для швидкості розряду.
  - Наприклад, батарея на 2000 мАг (незалежно від напруги) з розрядом 10C може безпечно і безперервно витікати 20 амперів струму (2000/1000=2Аг x 10C = 20 амперів).
- C рейтинги завжди надаються виробником (часто на зовнішній частині батарейного блоку). Хоча їх можна фактично обчислити, вам потрібно кілька частин інформації, і виміряти внутрішній опір клітинок.
- Акумулятори LiPo завжди матимуть вищий рейтинг C, ніж акумулятор Li-Ion. Це пов'язано з типом хімії, а також з внутрішнім опором на кожну клітину (що пов'язано з типом хімії), що призводить до вищих рівнів розряду для акумуляторів LiPo.
- Дотримання виробників рекомендацій щодо обох рейтингів C для заряду та розряду є дуже важливим для здоров'я вашого акумулятора та безпечної експлуатації вашого транспортного засобу (тобто запобігання пожеж, "надування" пакетів та інших неоптимальних станів під час зарядки та розрядки).

### Енергетична щільність

- Енергетична щільність - це скільки енергії може бути збережено відносно ваги батареї. Зазвичай вимірюється і порівнюється у ват-годинах на кілограм (Вт•год/кг).
  - Ват-години просто розраховуються шляхом множення номінальної (тобто не повністю зарядної напруги) на ємність, наприклад, 3,7 В х 5 Аг = 18,5 Вт-г. Якби у вас був акумулятор на 3 клітки, ваш пакет був би 18,5 Вт·год X 3 = 55 Вт збереженої енергії.
- Коли ви враховуєте вагу батареї, ви розраховуєте енергетичну щільність, взявши ват-години і поділивши їх на вагу.
  - Наприклад, 55 Вт годин поділено на (вага батареї в грамах поділена на 1000). Припускаючи, що ця батарея важить 300 грам, тоді 55/(300/1000)=185 Вт·г/кг.
- Це число 185 Вт/кг було б на дуже високому рівні для акумулятора LiPo. Літій-іонна батарея, з іншого боку, може досягти 260 Вт·год/кг, що означає, що на кожний кілограм батареї на борту ви можете переносити на 75 Вт·год більше.
  - Якщо ви знаєте, скільки ватт потрібно вашому транспортному засобу для польоту (що може показати модуль поточного батареї), ви можете віднести це збільшене зберігання без додаткової ваги до збільшеного часу польоту.
