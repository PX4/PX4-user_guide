# Датчик тахометра ThunderFly TFRPM01

Тахометр [TFRPM01](https://github.com/ThunderFly-aerospace/TFRPM01) - це невеликий та низькосистемний вимірювач обертів.

Сама плата не містить фактичного датчика, але може бути використана з багатьма різними типами датчиків/зондів для підрахунку обертів. Він має роз'єм I²C для підключення до PX4 та підключений до фактичного датчика через 3-контактний роз'єм. Також він має світлодіод, який надає базову діагностичну інформацію.

![TFRPM01A](../../assets/hardware/sensors/tfrpm/tfrpm01_electronics.jpg)

:::info Датчик TFRPM01 є апаратним засобом з відкритим вихідним кодом, який комерційно доступний на веб-сайті [ThunderFly s.r.o.](https://www.thunderfly.cz/) (виробничі дані доступні на [GitHub](https://github.com/ThunderFly-aerospace/TFRPM01)).
:::

## Налаштування обладнання

Плата обладнана (двома крізь прохідними) роз'ємами I²C для підключення до PX4 та має 3-контактний роз'єм, який можна використовувати для підключення до різних датчиків:

- TFRPM01 може бути підключений до будь-якого порту I²C.
- TFRPM01 має роз'єм з 3 контактами (з входом з підтяжкою), який може бути підключений до різних типів зондів.
  - Апаратне забезпечення датчика/зонда потребує імпульсного сигналу. Вхідний сигнал приймає логіку TTL зі значенням +5V або [відкриті вихідні](https://en.wikipedia.org/wiki/Open_collector) колектори. Максимальна частота пульса - 20 кГц з циклом роботи 50%.
  - Раз'єм зонду забезпечує живлення +5V від шини I²C, максимальна потужність, яку можна використовувати, обмежена фільтром RC (див. схеми для деталей).

Електроніка TFRPM01A обладнана сигнальним світлодіодом, який може бути використаний для перевірки правильного підключення датчика. Світлодіод загоряється, коли вхід імпульсу заземлений або відкритий для логічного 0, тому ви можете перевірити, що датчик працює правильно, просто обертаючи ротор вручну.

### Зонд сенсора ефекту Холла

Датчики Холла (магнітно-оперовані) ідеально підходять для жорстких умов, де бруд, пил і вода можуть контактувати з відчуваним ротором.

Багато різних датчиків ефекту Холла є комерційно доступними. Наприклад, гарним вибором є [мініатюрний датчик наближення з фланцевим кріпленням 55100](https://m.littelfuse.com/media?resourcetype=datasheets&itemid=6d69d457-770e-46ba-9998-012c5e0aedd7&filename=littelfuse-hall-effect-sensors-55100-datasheet).

![Example of Hall effect probe](../../assets/hardware/sensors/tfrpm/hall_probe.jpg)

### Оптичний датчик зонду

Оптичний сенсор також може бути використаний (і може бути кращим варіантом, залежно від вимог до вимірювань). Як трансмісивний, так і рефлекторний типи сенсорів можуть бути використані для генерації імпульсів.

![Example of optical transmissive probe](../../assets/hardware/sensors/tfrpm/transmissive_probe.jpg)

## Налаштування програмного забезпечення

### Запуск драйвера

Драйвер не запускається автоматично (в будь-якій конструкції). Вам потрібно буде запустити його вручну, використовуючи [QGroundControl MAVLink Console](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_console.html) або додавши драйвер до [скрипту запуску](../concept/system_startup.md#customizing-the-system-startup) на SD-картку.

#### Запустіть драйвер з консолі

Запустіть драйвер з [консолі](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_console.html) за допомогою команди:

```sh
pcf8583 start -X -b <bus number>
```

де:

- `-X` означає, що це зовнішня шина.
- `<bus number>` - це номер шини, до якого підключений пристрій

:::info Номер шини в коді `-b <номер шини>` може не відповідати міткам автобусів на автопілоті. Наприклад, при використанні CUAV V5+ або CUAV Nano:

| Мітка автопілоту | -b номер |
| ---------------- | -------- |
| I2C1             | -X -b 4  |
| I2C2             | -X -b 2  |
| I2C3             | -X -b 1  |

Команда `pcf8583 start` виводить відповідну назву / мітку автопілота для кожного номера шини.
:::

### Тестування

Ви можете перевірити, що лічильник працює, використовуючи кілька методів

#### PX4 (NuttX) Консоль MAVLink

Консоль [QGroundControl MAVLink](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_console.html) також може використовуватися для перевірки роботи драйвера і теми UORB, які він виводить.

Щоб перевірити статус драйвера TFRPM01, виконайте команду:

```sh
pcf8583 status
```

Якщо драйвер працює, порт I²C буде надруковано разом з іншими основними параметрами запущеного екземпляру. Якщо драйвер не працює, його можна запустити за допомогою процедури, описаної вище.

Команда [listener](../modules/modules_command.md#listener) дозволяє відстежувати повідомлення RPM UORB від працюючого драйвера.

```sh
listener rpm
```

Для періодичного відображення ви можете додати параметр `-n 50` після команди, яка виводить наступні 50 повідомлень.

#### Консоль QGroundControl MAVLink Інспектор

Інспектор  QGroundControl [Mavlink](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_inspector.html) може бути використаний для спостереження повідомлень MAVLink від PX4, включаючи [RAW_RPM](https://mavlink.io/en/messages/common.html#RAW_RPM), випромінюваних драйвером:

1. Запустіть інспектор з меню QGC: **Аналіз інструментів >  Mavlink Інспектор**
1. Перевірте, чи `RAW_RPM` присутній у списку повідомлень (якщо він відсутній, перевірте, чи працює драйвер).

### Налаштування параметрів

Зазвичай, сенсори можуть бути використані без конфігурації, але значення обертів на хвилину повинні відповідати кратними реальним обертам. Це через те, що параметр `PCF8583_MAGNET` повинен відповідати реальній кількості імпульсів на один оберт відчутого ротора. Якщо потрібно, наступні параметри слід налаштувати:

- [PCF8583_POOL](../advanced_config/parameter_reference.md#PCF8583_POOL) — інтервал об'єднання між переліком зарахованого номера
- [СБРОС_PC8583](../advanced_config/parameter_reference.md#PCF8583_RESET) — Значення лічильника, де підраховане число повинно бути скинуто на нуль.
- [PCF8583_MAGNET](../advanced_config/parameter_reference.md#PCF8583_MAGNET) — Кількість імпульсів на обертання, наприклад, кількість магнітів на диску ротора.

:::info Параметри вище з'являються в QGC після перезапуску драйвера/PX4.

Якщо параметри конфігурації не доступні після перезапуску, то вам слід перевірити, чи відбувся запуск драйвера. Можливо, що [драйвер відсутній в прошивці](../peripherals/serial_configuration.md#configuration-parameter-missing-from-qgroundcontrol), у такому випадку його потрібно додати до конфігурації плати:

```sh
drivers/rpm/pcf8583
```

:::
