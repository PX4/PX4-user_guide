# Оптичний потік

_Датчики оптичного потоку_ використовують камеру та датчик відстані направлені вниз для оцінки швидкості.

@[youtube](https://youtu.be/aPQKgUof3Pc) _Відео: PX4 утримує позицію за допомогою датчика потоку ARK для оцінки швидкості (у [Режим позиції](../flight_modes_mc/position.md))._

<!-- ARK Flow with PX4 Optical Flow Position Hold: 20210605 -->

## Установка

Налаштування оптичного потоку вимагає камери, спрямованої вниз, та [датчика відстані](../sensor/rangefinders.md) (найкраще LiDAR). Ці можуть бути підключені через MAVLink, I2C або будь-яку іншу шину, яка підтримує периферійні пристрої.

:::note
Якщо підключено до PX4 через MAVLink, пристрій оптичного потоку повинен публікувати в тему [OPTICAL_FLOW_RAD](https://mavlink.io/en/messages/common.html#OPTICAL_FLOW_RAD), а датчик відстані повинен публікувати в тему [DISTANCE_SENSOR](https://mavlink.io/en/messages/common.html#DISTANCE_SENSOR).
:::

Вихід потоку при руху в різних напрямках повинен бути наступним:

| Рух транспортного засобу | Інтегрований потік |
| ------------------------ | ------------------ |
| Вперед                   | + Y                |
| Назад                    | - Y                |
| Справа                   | - X                |
| Зліва                    | + X                |

Для чистих обертань `integrated_xgyro` та `integrated_x` (відповідно `integrated_ygyro` та `integrated_y`) повинні бути однаковими.

Популярним варіантом є [PX4Flow](../sensor/px4flow.md) та [Lidar-Lite](../sensor/lidar_lite.md), як показано нижче.

![Optical flow lidar attached](../../assets/hardware/sensors/optical_flow/flow_lidar_attached.jpg)

Дані сенсора від пристрою оптичного потоку об'єднуються з іншими джерелами даних швидкості. Підхід, який використовується для об'єднання даних сенсора та будь-яких зміщень від центру транспортного засобу, повинен бути налаштований в [оцінювачі](#estimators).

## Датчики потоку/Камери

### ARK Flow

[ARK Flow](../dronecan/ark_flow.md) є оптичним датчиком потоку для [DroneCAN](../dronecan/index.md), датчиком відстані та ІНС. В ньому є оптичний датчик потоку PAW3902, оптичний датчик відстані Broadcom AFBR-S50LV85D на відстані 30 метрів та ІМП-датчик BMI088.

### Датчики на основі PMW3901

[PMW3901](../sensor/pmw3901.md) є оптичним сенсором відстеження потоку, схожим на те, що ви знайдете в комп'ютерній мишці, але адаптованим для роботи від 80 мм і безмежжя. Він використовується в ряді продуктів, включаючи деякі від: Bitcraze, Tindie, Hex, Thone та Alientek.

### Інші Камери/Сенсори

Також можна використовувати дошку/квадрокоптер, яка має вбудовану камеру. Для цього можна використовувати репозиторій [Optical Flow](https://github.com/PX4/OpticalFlow) (див. також [snap_cam](https://github.com/PX4/snap_cam)).

## Далекомір

Ви можете використовувати будь-який підтримуваний [датчик відстані](../sensor/rangefinders.md). Проте ми рекомендуємо використовувати LIDAR замість зондів сонар, через їхню надійність та точність.

## Оцінювач

Оцінювачі об'єднують дані з датчика оптичного потоку та інших джерел. Налаштування для виконання злиття, а також відносні зсуви до центру транспортного засобу повинні бути вказані для використаного оцінювача.

Зміщення обчислюються відносно орієнтації транспортного засобу та центру, як показано нижче:

![Optical Flow offsets](../../assets/hardware/sensors/optical_flow/px4flow_offset.png)

Оптична навігація на основі потоку даних активована обома доступними оцінювачами: EKF2 та LPE (застарілий).

<a id="ekf2"></a>

### Розширений фільтр Калмана (EKF2)

Для об'єднання оптичного потоку за допомогою EKF2 встановіть [EKF2_OF_CTRL](../advanced_config/parameter_reference.md#EKF2_OF_CTRL).

Якщо ваш оптичний датчик потоку зміщений від центру транспортного засобу, ви можете встановити це за допомогою наступних параметрів.

| Параметр                                                                                            | Опис                                                                               |
| --------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| <a id="EKF2_OF_POS_X"></a>[EKF2_OF_POS_X](../advanced_config/parameter_reference.md#EKF2_OF_POS_X) | Позиція X оптичного потоку фокусної точки в системі тіла (за замовчуванням 0.0 м). |
| <a id="EKF2_OF_POS_Y"></a>[EKF2_OF_POS_Y](../advanced_config/parameter_reference.md#EKF2_OF_POS_Y) | Позиція Y оптичного потоку фокусної точки в системі тіла (за замовчуванням 0.0 м). |
| <a id="EKF2_OF_POS_Z"></a>[EKF2_OF_POS_Z](../advanced_config/parameter_reference.md#EKF2_OF_POS_Z) | Позиція Z оптичного потоку фокусної точки в системі тіла (за замовчуванням 0.0 м). |
