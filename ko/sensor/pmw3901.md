# PMW3901 기반 유량 센서

PMW3901은 내부적으로 흐름을 계산하고, 각 프레임 간의 픽셀 차이를 제공하는 [광류](../sensor/optical_flow.md) ASIC입니다. 컴퓨터 마우스와 유사한 추적 센서를 사용하지만 80mm에서 무한대 사이에서 작동하도록 조정되었습니다. PMW3901은 Bitcraze, Tindie, Hex, Thone 및 Alientek의 일부 제품을 포함하여 여러 제품에 사용됩니다.

![Bitcraze Flow Deck](../../assets/hardware/sensors/pmw3901/bitcraze-flow.jpg)

장착 방법, PX4 설정 방법과 테스트 센서에 대한 링크를 제공합니다 (이 유형의 모든 센서에 공통임).


## PMW3901을 사용하는 보드

다음 표는이 센서를 사용하는 일부 보드를 보여 주며, 인터페이스 수, 센서 수, 입력 전압 및 크기를 나열합니다. 보드 이름은 배선 및 구매 정보가 포함된 보드 별 섹션으로 연결됩니다.

| 제조사      | 보드                                              | 인터페이스 | 흐름 | 거리 측정기 | 자이로 | 전압 (V)    | 크기 (mm)   | 최대 높이 (m) |
| -------- | ----------------------------------------------- | ----- | -- | ------ | --- | --------- | --------- | --------- |
| Bitcraze | [Flow breakout](#bitcraze_flow_breakout)        | SPI   | Y  | Y      | -   | 3 - 5     | 21x20     | 1         |
| Tindie   | [PMW3901 광류 센서](#tindie_pmw3901_flow_sensor)    | SPI   | Y  | -      | -   | 3 - 5     | AxB       | -         |
| Hex      | [HereFlow PMW3901 광류 센서](#hex_hereflow_pwm3901) | CAN   | Y  | Y      | Y   | 3 - 5     | AxB       | 4         |
| Thone    | [ThoneFlow-3901U](#thone_thoneflow_3901U)       | UART  | Y  | -      | -   | 3 - 5     | AxB       | -         |
| Alientek | [ATK-PMW3901](#alientek_atk-pwm3901)            | SPI   | Y  | -      | -   | 3.3 - 4.2 | 27.5x16.5 | 1         |

<a id="external_rangefinder"></a>

## 외부 거리계

거리계가 없는 센서 (예: *Tindie* 또는 *Thone*)에는 외부 거리계/거리 센서가 *필수*이며 *권장됩니다.* 다른 보드의 경우 (범위가 매우 제한되어 있으므로).

필요한 범위는 애플리케이션에 따라 다릅니다.
- 실내 비행 : ≈4m
- 실외 비행 : ≥10 미터 (예 : GPS에 문제가 있을 수 있는 환경에서 위치 제어를 지원)

PX4에서 지원하는 [거리계/거리 센서](../sensor/rangefinders.md)를 사용할 수 있습니다. 센서는 어디나 장착할 수 있지만, 아래를 향해야하며 평소와 같이 연결/설정하여야 합니다.

:::tip PX4 팀은 주로 대형 기체에 [Lidar Lite V3](../sensor/lidar_lite.md)를 사용하고 소형 기체에 [Lanbao CM8JL65](../sensor/cm8jl65_ir_distance_sensor.md)를 사용하여 테스트 하였습니다.
:::

<a id="orientation"></a>

## 장착 및 방향

흐름 모듈은 일반적으로 차량 중앙 근처에 장착됩니다. 중심을 벗어난 곳에 장착하는 경우 오프셋을 설정하여야 합니다. [Optical Flow > EKF2](../sensor/optical_flow.md#ekf2).

흐름 모듈은 차체 프레임과 관련된 모든 요 방향으로 장착 할 수 있지만 [SENS_FLOW_ROT](../advanced_config/parameter_reference.md#SENS_FLOW_ROT)에 사용 된 값을 설정하여야 합니다.

"제로"회전은 센서 보드와 [기체](../getting_started/px4_basic_concepts.md#heading-and-directions) X 축이 정렬되어 (즉, 기체 "전면"과 보드가 같은 방향에 있음) 회전이 시계 방향으로 증가하는 경우입니다.

PMW3901 모듈에는 보드 **후방**을 나타내는 작은 노치가 있습니다. The diagram shows the relative board and vehicle orientations that correspond to `SENS_FLOW_ROT=0` (note the notch at the back).

![PMW3901 PH4 Rotation](../../assets/hardware/sensors/pmw3901/ph4-pmw3901-rotation.png)

The diagram above shows the Bitcraze board. You can use the notch to find the orientation of the other boards in the same way:

| &nbsp;                                                                                               | &nbsp;                                                                                                                                            |
| ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| Tindie<br>![PMW3901 Tindie Notch](../../assets/hardware/sensors/pmw3901/tindie_notch.jpg)            | Hex Hereflow<br>![PMW3901 Hereflow Notch](../../assets/hardware/sensors/pmw3901/hex_hereflow_notch.jpg)                                           |
| Thone<br>![PMW3901 Thoneflow Notch](../../assets/hardware/sensors/pmw3901/thoneflow_3901u_notch.jpg) | Alientek (also has an arrow indicating the front!)<br>![PMW3901 Alientek Notch](../../assets/hardware/sensors/pmw3901/alientek_pmw3901_notch.jpg) |

<a id="configuration"></a>

## PX4 Configuration

The PX4 configuration that is common to all PMW3901-based boards:
- [Optical Flow > EKF2](../sensor/optical_flow.md#ekf2) explains how to fuse optical flow data in the EKF2 estimator and set position offsets for the mounting position of the flow sensor.
- [SENS_FLOW_ROT](../advanced_config/parameter_reference.md#SENS_FLOW_ROT) sets the orientation of the flow sensor relative to vehicle heading.

In addition for:
- SPI-connected sensors you must set [SENS_EN_PMW3901](../advanced_config/parameter_reference.md#SENS_EN_PMW3901) to `1` in order to enable the sensor driver.
- UART-connected sensors (e.g. ThoneFlow-3901UY) you must [configure the associated serial port](../peripherals/serial_configuration.md) by setting the parameter [SENS_TFLOW_CFG](../advanced_config/parameter_reference.md#SENS_TFLOW_CFG) to the value of the connected UART port (for example, if you connected this sensor to `TELEM 2`, you need to set `SENS_TFLOW_CFG` to `102`).
- UAVCAN sensors you must set `UAVCAN_ENABLE` appropriately. For more information see [UAVCAN Peripherals](../uavcan/README.md) (and the [HereFlow PMW3901 docs below](#uavcan_wiring)).

Individual flow sensors are further setup/configured as described in the sections below.

<a id="bitcraze_flow_breakout"></a>

## Bitcraze Flow breakout

The [Bitcraze Flow breakout](https://www.bitcraze.io/products/flow-breakout/) directly exposes the [SPI interface](#spi_wiring) from the PMW3901 module.

The board also incorporates a distance sensor [wired to the Pixhawk I2C port](#i2c_wiring). This distance sensor is the VL53L0x ToF sensor from STMicroelectronics. The sensor range is minimal (2 metres) and will be reduced when flying in the sunlight. We therefore highly recommend that you use an [external distance sensor](#external_rangefinder).

![Bitcraze Flow Deck](../../assets/hardware/sensors/pmw3901/bitcraze-flow.jpg)

<a id="spi_wiring"></a>

### SPI Wiring

The PMW3901, if connected to the SPI port on a Pixhawk 4, will automatically detect the Bitcraze flow module. This device's driver was explicitly written to be plugged into the SPI port using the chip select 1. No parameters will have to be configured other than the [orientation and position of the sensor](#orientation).

The pinout mapping for the Pixhawk SPI port to Bitcraze Flow Board is shown below (the port mapping is the same for all Pixhawk FMU versions).

| Pixhawk SPI Port (from left to right) | Bitcraze flow board |
| ------------------------------------- | ------------------- |
| 1 (VCC)                               | VCC                 |
| 2 (SCK)                               | CLK                 |
| 3 (MISO)                              | MISO                |
| 4 (MOSI)                              | MOSI                |
| 5 (CS1)                               | Do not connect      |
| 6 (CS2)                               | CS                  |
| 7 (GND)                               | GND                 |

To connect the bitcraze flow board to the Pixhawk, you will need to solder the wires of the Pixhawk SPI cable to the flow board. An SPI cable has 7 wires, from which you need to connect 6 to the flow board.

The following diagram shows how to wire the sensor to a Pixhawk 4.

![Bitcraze PH4 Pinout](../../assets/hardware/sensors/pmw3901/ph4-bitcraze-flow-pinout.png)

<a id="i2c_wiring"></a>

### I2C Wiring

The I2C wiring is the same for any other distance sensor. Simply connect the SLA, SLC, GND, and VCC to the corresponding (same) pins on the Pixhawk and the sensor. 

<a id="tindie_pmw3901_flow_sensor"></a>

## Tindie PMW3901 Optical Flow Sensor

The Tindie [PMW3901 Optical Flow Sensor](https://www.tindie.com/products/onehorse/pmw3901-optical-flow-sensor/) exposes the SPI interface from the PMW3901 module exactly as on the Bitcraze module (see [SPI Wiring](#spi_wiring)).

![Tindie PH4 Pinout](../../assets/hardware/sensors/pmw3901/ph4-tindie-flow-pinout.png)

The sensor doesn't have a distance sensor onboard, so you will need to use an [external distance sensor](#external_rangefinder).

<span id="alientek_atk-pwm3901"></span>
## AlienTek ATK-PMW3901

The AlienTek [ATK-PMW3901](https://www.aliexpress.com/i/32979605707.html) exposes the SPI interface from the PMW3901 module in the same way as the Bitcraze module (see [SPI Wiring](#spi_wiring)).

![Alientek Pixhawk4 Connections](../../assets/hardware/sensors/pmw3901/ph4-alientek-flow-pinout.png)

The board also incorporates a distance sensor (we recommend that you use an [external distance sensor](#external_rangefinder)). You can wire the internal sensor to the Pixhawk I2C port [in the same way as any other I2C peripheral.](#i2c_wiring) A screenshot showing the I2C pins (SLA, SLC, GND, and VCC) is provided below.

![Alientek Pinout](../../assets/hardware/sensors/pmw3901/alientek.png)

<a id="hex_hereflow_pwm3901"></a>

## Hex HereFlow PMW3901 Optical Flow Sensor

The Hex [HereFlow PMW3901 Optical Flow Sensor](http://www.proficnc.com/all-products/185-pixhawk2-suite.html) is a tiny board containing the PMW3901 flow module, VL53L1X distance sensor, and an IMU (used to synchronize the flow data with the gyro data).

An onboard microcontroller samples the three sensors and publishes two UAVCAN messages containing all the information needed for the flow and distance sensor calculations.

The board can be connected to any CAN port on any Pixhawk board (see [UAVCAN wiring](#uavcan_wiring)).

As for the other optical flow boards, we recommend that you use an [external distance sensor](#external_rangefinder).

<a id="uavcan_wiring"></a>

### UAVCAN Wiring/Setup

The diagram below shows how to connect the sensor to the Pixhawk 4 CAN bus.

![Hex PH4 Pinout](../../assets/hardware/sensors/pmw3901/ph4-hex-optical-flow.png)

In addition to any other configuration, you will need to set the parameter [UAVCAN_ENABLE](../advanced_config/parameter_reference.md#UAVCAN_ENABLE) to either 2 or 3, depending on your system:
- `UAVCAN_ENABLE=2`: UAVCAN sensors but no motor controllers.
- `UAVCAN_ENABLE=3`: UAVCAN sensors and motor controllers.

For general information about UAVCAN wiring and configuration see: [UAVCAN Peripherals](../uavcan/README.md).

<a id="thone_thoneflow_3901U"></a>

## Thone ThoneFlow-3901U

The Thone [ThoneFlow-3901U](https://www.seeedstudio.com/ThoneFlow-3901U-UART-Serial-Version-PMW3901-Optical-Flow-Sensor-p-4040.html) exposes a PMW3901 optical flow module via a UART interface.

The board doesn't include a distance sensor onboard, so you will need to use an [external distance sensor](#external_rangefinder).

![PMW3901 Thoneflow Hero](../../assets/hardware/sensors/pmw3901/thoneflow_3901u_hero.jpg)


<!-- note, this will be set using SENS_TFLOW_CFG
Wiring is also required.
--> In addition to the general 

[PX4 configuration](#px4-configuration) you must also set the parameter [SENS_TFLOW_CFG](../advanced_config/parameter_reference.md#SENS_TFLOW_CFG) to the value of the UART port you connected (e.g. if the sensor is connected to `TELEM 2` then set `SENS_TFLOW_CFG=102`. For more information see [Serial Port Configuration](../peripherals/serial_configuration.md).

